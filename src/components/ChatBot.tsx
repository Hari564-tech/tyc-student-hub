import React, { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Send, Bot, User, Key, Settings } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';

interface Message {
  id: string;
  text: string;
  sender: 'user' | 'bot';
  timestamp: Date;
}

const ChatBot = () => {
  const [messages, setMessages] = useState<Message[]>([
    {
      id: '1',
      text: 'üöÄ EXCITING NEWS! We just launched our Python Programming Complete Course for only ‚Çπ2,000 (regular price ‚Çπ2,999)!\n\nCourse includes:\n‚úÖ Basic Python Programming\n‚úÖ Advanced Python Concepts\n‚úÖ Data Structures & Algorithms in Python\n‚úÖ 10 weeks of comprehensive training\n‚úÖ Hands-on projects and assignments\n\nThis is a limited-time launch offer! Ask me about Python or any other programming language, technical subjects, courses, study materials, applications, and career guidance.\n\nü§ñ Enhanced with AI: I can now provide more intelligent and detailed responses!',
      sender: 'bot',
      timestamp: new Date()
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [apiKey, setApiKey] = useState(localStorage.getItem('gemini-api-key') || '');
  const [showApiDialog, setShowApiDialog] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const callGeminiAPI = async (userMessage: string): Promise<string> => {
    if (!apiKey) {
      return "üîë Please set up your Gemini API key in settings to use AI-enhanced responses!";
    }

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: `You are TYC (Telugu Youth Citizens) Technical Assistant. You help with programming languages, technical subjects, career guidance, and courses. Our current offerings include:

NEW LAUNCH: Python Complete Course - ‚Çπ2,000 (Basic + Advanced + DSA)
- Java Full Stack: ‚Çπ4,999
- Web Development: ‚Çπ5,999  
- Data Science: ‚Çπ6,999
- Mobile Development: ‚Çπ4,499
- Cybersecurity: ‚Çπ6,499
- Career Guidance: ‚Çπ1,999

Study materials: ‚Çπ99-299 per subject
Application assistance: ‚Çπ50 per form

Always promote our courses when relevant. Be helpful, technical, and professional.

User question: ${userMessage}`
            }]
          }]
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || getFallbackResponse(userMessage);
    } catch (error) {
      console.error('Gemini API error:', error);
      return getFallbackResponse(userMessage);
    }
  };

  const getFallbackResponse = (userMessage: string): string => {
    const message = userMessage.toLowerCase();

    // Programming Languages - Python (Updated with new course info)
    if (message.includes('python') || message.includes('py')) {
      return 'üêç GREAT NEWS! We just launched our Python Programming Complete Course!\n\nüéâ **SPECIAL LAUNCH OFFER: ‚Çπ2,000 only** (Regular price: ‚Çπ2,999)\n\nüìö **Course Coverage:**\n‚Ä¢ **Basic Python:** Variables, data types, loops, functions, file handling\n‚Ä¢ **Advanced Python:** OOP, decorators, generators, exception handling\n‚Ä¢ **DSA in Python:** Arrays, linked lists, stacks, queues, trees, graphs, sorting algorithms\n‚Ä¢ **Libraries:** NumPy, Pandas, Matplotlib basics\n‚Ä¢ **Projects:** Real-world applications and portfolio building\n\n‚è∞ **Duration:** 10 weeks with hands-on practice\nüéì **Level:** Beginner to Advanced\nüë• **Already enrolled:** 1800+ students\n‚≠ê **Rating:** 4.9/5\n\nüî• This is a limited-time launch price! Perfect for beginners and those wanting to master DSA concepts.';
    }

    // Java Programming
    if (message.includes('java') && !message.includes('javascript')) {
      return 'Java is excellent for enterprise development! Our Java course includes:\n\n‚Ä¢ Core Java: Syntax, OOP concepts, inheritance\n‚Ä¢ Advanced Java: Collections, multithreading, exception handling\n‚Ä¢ Frameworks: Spring, Spring Boot, Hibernate\n‚Ä¢ Database: JDBC, MySQL integration\n‚Ä¢ Projects: Full-stack applications, REST APIs\n\nJava Full Stack course: ‚Çπ4,999 for 12 weeks with industry projects!';
    }

    // JavaScript & Web Development
    if (message.includes('javascript') || message.includes('js') || message.includes('web development') || message.includes('frontend') || message.includes('react') || message.includes('node')) {
      return 'JavaScript is the backbone of web development! TYC covers:\n\n‚Ä¢ Frontend: HTML5, CSS3, JavaScript ES6+\n‚Ä¢ Frameworks: React.js, Vue.js, Angular\n‚Ä¢ Backend: Node.js, Express.js\n‚Ä¢ Database: MongoDB, PostgreSQL\n‚Ä¢ Tools: Git, Webpack, npm/yarn\n‚Ä¢ Projects: Responsive websites, SPAs, full-stack apps\n\nWeb Development Bootcamp: ‚Çπ5,999 for 16 weeks!';
    }

    // C++ Programming
    if (message.includes('c++') || message.includes('cpp') || message.includes('c plus')) {
      return 'C++ is powerful for system programming and competitive coding! Our curriculum:\n\n‚Ä¢ Fundamentals: Syntax, pointers, memory management\n‚Ä¢ OOP: Classes, objects, inheritance, polymorphism\n‚Ä¢ STL: Containers, algorithms, iterators\n‚Ä¢ Advanced: Templates, exception handling\n‚Ä¢ Applications: Game development, system programming\n‚Ä¢ Problem Solving: Data structures, algorithms\n\nC++ course: ‚Çπ3,499 for 10 weeks with coding practice!';
    }

    // Data Science & Analytics
    if (message.includes('data science') || message.includes('machine learning') || message.includes('ml') || message.includes('ai') || message.includes('analytics')) {
      return 'Data Science is the future! TYC offers comprehensive training:\n\n‚Ä¢ Python for Data Science: Pandas, NumPy, Matplotlib\n‚Ä¢ Statistics & Mathematics for DS\n‚Ä¢ Machine Learning: Scikit-learn, algorithms\n‚Ä¢ Deep Learning: TensorFlow, PyTorch\n‚Ä¢ Tools: Jupyter, Git, SQL databases\n‚Ä¢ Projects: Real datasets, predictive models\n\nData Science course: ‚Çπ6,999 for 14 weeks with industry projects!';
    }

    // Mobile App Development
    if (message.includes('mobile') || message.includes('android') || message.includes('ios') || message.includes('app development') || message.includes('flutter') || message.includes('react native')) {
      return 'Mobile app development is in high demand! We teach:\n\n‚Ä¢ Android: Java/Kotlin, Android Studio\n‚Ä¢ iOS: Swift, Xcode development\n‚Ä¢ Cross-platform: Flutter, React Native\n‚Ä¢ UI/UX: Material Design, Human Interface Guidelines\n‚Ä¢ Backend: Firebase, REST APIs\n‚Ä¢ Deployment: Play Store, App Store publishing\n\nMobile Development course: ‚Çπ4,499 for 12 weeks!';
    }

    // Database & Backend
    if (message.includes('database') || message.includes('sql') || message.includes('mysql') || message.includes('mongodb') || message.includes('backend')) {
      return 'Database skills are essential for any developer! Our coverage:\n\n‚Ä¢ SQL Databases: MySQL, PostgreSQL, SQLite\n‚Ä¢ NoSQL: MongoDB, Firebase\n‚Ä¢ Database Design: Normalization, relationships\n‚Ä¢ Backend Development: APIs, server-side logic\n‚Ä¢ Cloud Databases: AWS RDS, Google Cloud SQL\n‚Ä¢ Performance: Indexing, query optimization\n\nDatabase & Backend course: ‚Çπ3,999 for 10 weeks!';
    }

    // DevOps & Cloud
    if (message.includes('devops') || message.includes('cloud') || message.includes('aws') || message.includes('docker') || message.includes('kubernetes')) {
      return 'DevOps and Cloud computing are crucial modern skills!\n\n‚Ä¢ Cloud Platforms: AWS, Google Cloud, Azure\n‚Ä¢ Containerization: Docker, Kubernetes\n‚Ä¢ CI/CD: Jenkins, GitHub Actions\n‚Ä¢ Infrastructure: Terraform, Ansible\n‚Ä¢ Monitoring: Prometheus, Grafana\n‚Ä¢ Security: Best practices, compliance\n\nDevOps course: ‚Çπ5,499 for 12 weeks with hands-on labs!';
    }

    // Cybersecurity
    if (message.includes('cybersecurity') || message.includes('security') || message.includes('ethical hacking') || message.includes('penetration testing')) {
      return 'Cybersecurity is a growing field with excellent opportunities!\n\n‚Ä¢ Network Security: Firewalls, VPNs, protocols\n‚Ä¢ Ethical Hacking: Penetration testing, vulnerability assessment\n‚Ä¢ Tools: Kali Linux, Wireshark, Metasploit\n‚Ä¢ Cryptography: Encryption, digital signatures\n‚Ä¢ Compliance: GDPR, ISO 27001\n‚Ä¢ Incident Response: Forensics, recovery\n\nCybersecurity course: ‚Çπ6,499 for 14 weeks with practical labs!';
    }

    // Game Development
    if (message.includes('game development') || message.includes('unity') || message.includes('unreal') || message.includes('game design')) {
      return 'Game development combines creativity with technical skills!\n\n‚Ä¢ Game Engines: Unity, Unreal Engine\n‚Ä¢ Programming: C#, C++, scripting\n‚Ä¢ 2D/3D Graphics: Sprites, models, animations\n‚Ä¢ Physics: Collision detection, movement\n‚Ä¢ UI/UX: Game interfaces, user experience\n‚Ä¢ Publishing: Steam, mobile app stores\n\nGame Development course: ‚Çπ4,999 for 12 weeks with game projects!';
    }

    // Academic Subjects - Mathematics
    if (message.includes('mathematics') || message.includes('math') || message.includes('calculus') || message.includes('algebra')) {
      return 'Mathematics is fundamental for engineering and computer science!\n\n‚Ä¢ Engineering Mathematics: Calculus, linear algebra, differential equations\n‚Ä¢ Discrete Mathematics: Logic, sets, combinatorics\n‚Ä¢ Statistics & Probability: Data analysis, distributions\n‚Ä¢ Study Materials: Formula sheets, solved examples\n‚Ä¢ Practice: Previous year questions, mock tests\n\nMath study materials: ‚Çπ149-299 per subject with video explanations!';
    }

    // Physics for Engineering
    if (message.includes('physics') || message.includes('mechanics') || message.includes('thermodynamics')) {
      return 'Physics concepts are essential for engineering students!\n\n‚Ä¢ Classical Mechanics: Motion, forces, energy\n‚Ä¢ Thermodynamics: Heat, entropy, cycles\n‚Ä¢ Electromagnetics: Fields, waves, circuits\n‚Ä¢ Modern Physics: Quantum mechanics, relativity\n‚Ä¢ Lab Work: Experiments, measurements\n‚Ä¢ Applications: Real-world engineering problems\n\nPhysics materials: ‚Çπ199 with practical examples and simulations!';
    }

    // Electronics & Electrical
    if (message.includes('electronics') || message.includes('electrical') || message.includes('circuits') || message.includes('embedded')) {
      return 'Electronics and Electrical engineering have diverse applications!\n\n‚Ä¢ Circuit Analysis: Ohm\'s law, Kirchhoff\'s laws\n‚Ä¢ Digital Electronics: Logic gates, flip-flops\n‚Ä¢ Microcontrollers: Arduino, Raspberry Pi\n‚Ä¢ Power Systems: Generation, transmission, distribution\n‚Ä¢ Control Systems: Feedback, stability\n‚Ä¢ Projects: IoT devices, automation systems\n\nElectronics course: ‚Çπ3,999 for 10 weeks with hands-on projects!';
    }

    // Competitive Programming
    if (message.includes('competitive programming') || message.includes('coding contest') || message.includes('algorithm') || message.includes('data structure')) {
      return 'Competitive programming enhances problem-solving skills!\n\n‚Ä¢ Data Structures: Arrays, trees, graphs, heaps\n‚Ä¢ Algorithms: Sorting, searching, dynamic programming\n‚Ä¢ Problem Solving: Logical thinking, optimization\n‚Ä¢ Platforms: CodeChef, Codeforces, LeetCode\n‚Ä¢ Interview Prep: Technical interviews, coding rounds\n‚Ä¢ Practice: Regular contests, mock interviews\n\nDSA course: ‚Çπ3,999 for 10 weeks with 200+ problems!';
    }

    // Career and Interview Preparation
    if (message.includes('interview') || message.includes('job preparation') || message.includes('resume') || message.includes('career switch')) {
      return 'TYC provides comprehensive career guidance and interview preparation!\n\n‚Ä¢ Technical Interviews: Coding rounds, system design\n‚Ä¢ Resume Building: ATS-friendly formats, project highlighting\n‚Ä¢ Mock Interviews: Real-time practice sessions\n‚Ä¢ Soft Skills: Communication, leadership, teamwork\n‚Ä¢ Industry Insights: Current trends, salary negotiations\n‚Ä¢ Placement Support: Job referrals, company connections\n\nCareer Guidance package: ‚Çπ1,999 for 6 weeks with personalized mentoring!';
    }

    // Course and pricing queries
    if (message.includes('course') || message.includes('programming') || message.includes('learn coding')) {
      return 'üöÄ TYC offers comprehensive courses in all major programming languages and technologies:\n\nüî• **NEW LAUNCH - SPECIAL OFFER:**\nüêç Python Complete Course (‚Çπ2,000) - Basic + Advanced + DSA - 10 weeks\n\n**Other Popular Courses:**\n‚òï Java Full Stack (‚Çπ4,999) - 12 weeks\nüåê Web Development (‚Çπ5,999) - 16 weeks\nüìä Data Science (‚Çπ6,999) - 14 weeks\nüì± Mobile Development (‚Çπ4,499) - 12 weeks\nüõ°Ô∏è Cybersecurity (‚Çπ6,499) - 14 weeks\nüéØ Career Guidance (‚Çπ1,999) - 6 weeks\n\nAll courses include projects, certifications, and placement assistance!';
    }

    // Study materials queries
    if (message.includes('study material') || message.includes('notes') || message.includes('important question')) {
      return 'We provide comprehensive study materials for all technical subjects:\n\nüìö Programming Notes: Python, Java, C++, JavaScript\nüî¨ Engineering Subjects: Math, Physics, Electronics\nüìù Important Questions: Previous year papers, mock tests\nüí° Project Ideas: Complete implementation guides\nüéØ Interview Questions: Technical and HR rounds\n\nMost materials: ‚Çπ99-299 with regular updates and video explanations!';
    }

    // Application services queries
    if (message.includes('application') || message.includes('eapcet') || message.includes('kcet') || message.includes('gate') || message.includes('placement')) {
      return 'TYC offers application assistance for various technical and competitive exams:\n\nüéì Engineering Entrance: EAPCET, KCET, JEE\nüè¢ Job Applications: Placement drives, internships\nüìÑ Document Services: Resume formatting, cover letters\nüí≥ Government Forms: PAN Card, scholarships\nüìã Project Submissions: Academic and professional\n\nApplication assistance: ‚Çπ50 per form - much cheaper than external services!';
    }

    // Contact/enrollment queries
    if (message.includes('how to join') || message.includes('enroll') || message.includes('contact') || message.includes('register')) {
      return 'Ready to start your coding journey with TYC?\n\nüöÄ Quick Enrollment: Click "Get Started" on our homepage\nüìû Contact: +91 9876543210\nüìß Email: support@tyc.edu\nüè¢ Location: Hyderabad, Telangana\nüí¨ Live Chat: Available 24/7 for instant support\nüí∞ Payment: Flexible EMI options available\n\nJoin thousands of successful students who started their tech careers with TYC!';
    }

    // General greetings
    if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {
      return 'Hello! Welcome to TYC (Telugu Youth Citizens) - Your gateway to tech excellence! üöÄ\n\nI can help you with:\n\nüíª Programming Languages (Python, Java, JavaScript, C++)\nüìä Data Science & AI/ML\nüåê Web & Mobile Development\nüõ°Ô∏è Cybersecurity & DevOps\nüìö Study Materials & Academic Support\nüéØ Career Guidance & Interview Prep\n\nWhat would you like to explore today?';
    }

    // Default response
    return 'I\'m here to help with all your technical and academic queries! I can assist with:\n\nüíª Programming: Python, Java, JavaScript, C++, and more\nüìä Data Science, AI/ML, and Analytics\nüåê Web Development and Mobile Apps\nüõ°Ô∏è Cybersecurity and DevOps\nüìö Study Materials for Engineering subjects\nüéØ Career guidance and interview preparation\nüíº Application assistance for exams and jobs\n\nüî• **Don\'t miss our NEW Python Course launch offer - ‚Çπ2,000 only!**\n\nPlease ask me about any specific programming language, course, or technical topic you\'re interested in!';
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim()) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      text: inputMessage,
      sender: 'user',
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage('');
    setIsLoading(true);

    try {
      const botResponseText = apiKey ? 
        await callGeminiAPI(inputMessage) : 
        getFallbackResponse(inputMessage);

      const botResponse: Message = {
        id: (Date.now() + 1).toString(),
        text: botResponseText,
        sender: 'bot',
        timestamp: new Date()
      };

      setMessages(prev => [...prev, botResponse]);
    } catch (error) {
      const errorResponse: Message = {
        id: (Date.now() + 1).toString(),
        text: "Sorry, I encountered an error. Please try again.",
        sender: 'bot',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorResponse]);
    } finally {
      setIsLoading(false);
    }
  };

  const saveApiKey = () => {
    localStorage.setItem('gemini-api-key', apiKey);
    setShowApiDialog(false);
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSendMessage();
    }
  };

  return (
    <section className="py-20 bg-gray-900">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="text-center mb-12">
          <h3 className="text-4xl font-bold text-white mb-4">
            TYC Technical Assistant
          </h3>
          <p className="text-xl text-gray-300 max-w-2xl mx-auto">
            Get expert guidance on programming languages, technical subjects, career advice, and course recommendations. Your 24/7 coding mentor!
          </p>
        </div>
        
        <div className="max-w-4xl mx-auto">
          <Card className="bg-white shadow-2xl h-[500px]">
            <CardHeader className="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-t-lg">
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Bot className="w-6 h-6" />
                  TYC Technical Assistant - AI Enhanced {apiKey ? 'ü§ñ' : ''}
                </div>
                
                <Dialog open={showApiDialog} onOpenChange={setShowApiDialog}>
                  <DialogTrigger asChild>
                    <Button variant="outline" size="sm" className="text-white border-white hover:bg-white hover:text-blue-600">
                      <Settings className="w-4 h-4 mr-2" />
                      {apiKey ? 'AI Enabled' : 'Enable AI'}
                    </Button>
                  </DialogTrigger>
                  <DialogContent className="sm:max-w-md">
                    <DialogHeader>
                      <DialogTitle>Configure Gemini AI</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4">
                      <p className="text-sm text-gray-600">
                        Enter your Google Gemini API key to enable AI-enhanced responses:
                      </p>
                      <Input
                        type="password"
                        placeholder="Your Gemini API key..."
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                      />
                      <div className="flex gap-2">
                        <Button onClick={saveApiKey} className="flex-1">
                          <Key className="w-4 h-4 mr-2" />
                          Save API Key
                        </Button>
                        <Button variant="outline" onClick={() => setShowApiDialog(false)}>
                          Cancel
                        </Button>
                      </div>
                      <p className="text-xs text-gray-500">
                        Your API key is stored locally and never shared.
                      </p>
                    </div>
                  </DialogContent>
                </Dialog>
              </CardTitle>
            </CardHeader>
            
            <CardContent className="flex flex-col h-[420px] p-0">
              {/* Messages Area */}
              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {messages.map((message) => (
                  <div
                    key={message.id}
                    className={`flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div
                      className={`max-w-[85%] p-4 rounded-lg ${
                        message.sender === 'user'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-900'
                      }`}
                    >
                      <div className="flex items-start space-x-3">
                        {message.sender === 'bot' && (
                          <Bot className="w-5 h-5 mt-1 text-blue-600 flex-shrink-0" />
                        )}
                        {message.sender === 'user' && (
                          <User className="w-5 h-5 mt-1 text-white flex-shrink-0" />
                        )}
                        <p className="text-sm leading-relaxed whitespace-pre-line">{message.text}</p>
                      </div>
                    </div>
                  </div>
                ))}
                
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="max-w-[85%] p-4 rounded-lg bg-gray-100 text-gray-900">
                      <div className="flex items-start space-x-3">
                        <Bot className="w-5 h-5 mt-1 text-blue-600 flex-shrink-0" />
                        <p className="text-sm">ü§ñ AI is thinking...</p>
                      </div>
                    </div>
                  </div>
                )}
                
                <div ref={messagesEndRef} />
              </div>

              {/* Input Area */}
              <div className="p-6 border-t bg-gray-50">
                <div className="flex space-x-3">
                  <Input
                    value={inputMessage}
                    onChange={(e) => setInputMessage(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="Ask about our NEW Python course or any programming topic..."
                    className="flex-1 bg-white"
                  />
                  <Button onClick={handleSendMessage} className="bg-blue-600 hover:bg-blue-700">
                    <Send className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </section>
  );
};

export default ChatBot;
